#!/bin/bash

# چک کردن نصب بودن zip و unzip
if ! command -v zip &> /dev/null || ! command -v unzip &> /dev/null; then
    read -p "zip and unzip are not installed. Do you want to install them? (y/n): " confirm_install
    if [[ "$confirm_install" == "y" ]]; then
        sudo apt install zip unzip -y
    else
        echo "Installation aborted."
        exit 1
    fi
fi

# گرفتن حجم پوشه /opt/marzban
opt_marzban_size=$(du -s /opt/marzban | awk '{print $1}')
opt_marzban_size_gb=$((opt_marzban_size / 1024 / 1024))

# گرفتن حجم پوشه /var/lib/marzban
lib_marzban_size=$(du -s /var/lib/marzban | awk '{print $1}')
lib_marzban_size_gb=$((lib_marzban_size / 1024 / 1024))

# جمع حجم پوشه‌های /opt/marzban و /var/lib/marzban
total_marzban_size_gb=$((opt_marzban_size_gb + lib_marzban_size_gb))
echo "Total MARZBAN Files Size: ${total_marzban_size_gb}G"

# اجرای bench.sh برای بررسی فضای کلی و خالی دیسک
echo "Checking total disk size and free space..."
disk_info=$(wget -qO- bench.sh | bash | grep -E 'Disk|Avail' | head -n 2)

# گرفتن فضای دیسک خالی از خروجی bench.sh
free_disk_space_gb=$(echo "$disk_info" | awk 'NR==2 {print $4}' | sed 's/G//')

# مقایسه فضای خالی با حجم فایل‌های مرزبان
if (( free_disk_space_gb > total_marzban_size_gb )); then
    echo "There is enough space. Continuing with zip and unzip operations."
else
    echo "There is not enough space to continue with zip and unzip operations. Exiting..."
    exit 1
fi

# سوال برای زیپ کردن پوشه‌ها
read -p "Do you want to create a zip file for the displayed directories? (y/n): " confirm_zip
if [[ "$confirm_zip" == "y" ]]; then
    # زیپ کردن پوشه /opt/marzban
    cd /opt
    zip -r marzban.zip marzban/
    echo "Zipped /opt/marzban"
    
    # زیپ کردن پوشه /var/lib/marzban
    cd /var/lib
    zip -r marzban.zip marzban/
    echo "Zipped /var/lib/marzban"
fi

# سوال برای آپدیت پنل Marzban
read -p "Do you want to update the Marzban panel? (y/n): " confirm_update
if [[ "$confirm_update" == "y" ]]; then
    cd /
    marzban update
    sleep 40
    echo "Update completed. If you need to restore the zip files, please run the script again."
fi

# مرحله بازگردانی اطلاعات ZIP
echo "UNZIP"
read -p "Do you want to restore your backup files? (y/n): " confirm_unzip
if [[ "$confirm_unzip" == "y" ]]; then
    cd /opt
    unzip marzban.zip
    rm marzban.zip

    cd /var/lib
    unzip marzban.zip
    rm marzban.zip
fi

echo "Thank you for running the script!"
exit 0
